<%- include('partials/header', { title: 'Levering ' + delivery.delivery_number }) %>

<!-- Page Header -->
<div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold text-gray-900 tracking-tight uppercase">
        LEVERING <%= delivery.delivery_number %>
    </h1>
    <div class="flex items-center gap-3">
        <button onclick="window.location.href='/deliveries'" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Terug naar overzicht
        </button>
        <% if (delivery.status === 'concept') { %>
            <form method="POST" action="/deliveries/<%= delivery.id %>/book" style="display: inline;">
                <button type="submit" onclick="return confirm('Weet je zeker dat je deze levering wilt boeken? Dit kan niet ongedaan worden gemaakt.')" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>
                    Boek levering
                </button>
            </form>
        <% } %>
    </div>
</div>

<!-- Delivery Info -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Delivery Information -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                Levering informatie
            </h2>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-500">Leveringsnummer:</span>
                <span class="text-sm text-gray-900 font-medium"><%= delivery.delivery_number %></span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-500">Leveringsdatum:</span>
                <span class="text-sm text-gray-900"><%= new Date(delivery.delivery_date).toLocaleDateString('nl-NL') %></span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-500">Leverancier:</span>
                <span class="text-sm text-gray-900"><%= delivery.supplier || 'Niet opgegeven' %></span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-500">Status:</span>
                <div>
                    <% 
                        let statusClass = '';
                        let statusText = '';
                        switch(delivery.status) {
                            case 'concept':
                                statusClass = 'bg-gray-100 text-gray-700';
                                statusText = 'Concept';
                                break;
                            case 'booked':
                                statusClass = 'bg-green-100 text-green-700';
                                statusText = 'Geboekt';
                                break;
                            case 'partially_booked':
                                statusClass = 'bg-amber-100 text-amber-700';
                                statusText = 'Gedeeltelijk geboekt';
                                break;
                        }
                    %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= statusClass %>">
                        <%= statusText %>
                    </span>
                </div>
            </div>
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-500">Aangemaakt:</span>
                <span class="text-sm text-gray-900"><%= new Date(delivery.created_at).toLocaleString('nl-NL') %></span>
            </div>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                Statistieken
            </h2>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600 mb-1"><%= lines.length %></div>
                <div class="text-sm text-gray-500">Productregels</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600 mb-1">
                    <%= lines.reduce((sum, line) => sum + line.quantity, 0) %>
                </div>
                <div class="text-sm text-gray-500">Totaal stuks</div>
            </div>
        </div>
    </div>
</div>

<!-- Add New Product Line -->
<% if (delivery.status === 'concept') { %>
<div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
    <div class="mb-4">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-plus mr-2 text-green-600"></i>
            Productregel toevoegen
        </h2>
    </div>
    <div>
        <form method="POST" action="/deliveries/<%= delivery.id %>/lines" id="addLineForm">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="product_version_id" class="form-label">Productversie *</label>
                    <select class="form-select" id="product_version_id" name="product_version_id" required>
                        <option value="">Selecteer productversie</option>
                        <% productVersions.forEach(pv => { %>
                            <option value="<%= pv.id %>" data-tracking="<%= pv.tracking_mode %>">
                                <%= pv.name %>
                            </option>
                        <% }); %>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="quantity" class="form-label">Aantal *</label>
                    <input 
                        type="number" 
                        class="form-control" 
                        id="quantity" 
                        name="quantity" 
                        min="1" 
                        required>
                </div>
                <div class="col-md-2">
                    <label for="purchase_price_per_unit" class="form-label">Inkoopprijs *</label>
                    <div class="input-group">
                        <span class="input-group-text">â‚¬</span>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="purchase_price_per_unit" 
                            name="purchase_price_per_unit" 
                            step="0.01"
                            min="0.01"
                            placeholder="0.00"
                            required>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Trackingconfiguratie</label>
                    <div id="trackingInfo" class="form-text">
                        Selecteer eerst een productversie
                    </div>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Identifier Fields (shown based on tracking mode) -->
            <div id="identifierFields" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Voer de identifiers in voor de geselecteerde productversie.
                </div>
                <div id="identifierInputs"></div>
            </div>
        </form>
    </div>
</div>
<% } %>

<!-- Existing Product Lines -->
<div class="bg-white rounded-lg border border-gray-200 overflow-hidden mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-list mr-2 text-blue-600"></i>
            Productregels (<%= lines.length %>)
        </h2>
    </div>
    <div>
        <% if (lines.length === 0) { %>
            <div class="text-center py-12">
                <i class="fas fa-boxes text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Geen productregels</h3>
                <p class="text-gray-500">Voeg productregels toe aan deze levering.</p>
            </div>
        <% } else { %>
            <table class="table-minimal w-full">
                <thead>
                    <tr>
                        <th class="text-left">Productversie</th>
                        <th class="text-left">Tracking Mode</th>
                        <th class="text-left">Aantal</th>
                        <th class="text-left">Inkoopprijs</th>
                        <th class="text-left">Totaal</th>
                        <th class="text-left">Toegevoegd</th>
                        <% if (delivery.status === 'concept') { %>
                            <th class="text-left">Acties</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                        <% lines.forEach(line => { %>
                            <tr class="group">
                                <td>
                                    <a href="/product-versions/<%= line.product_version_id %>" class="text-blue-600 hover:text-blue-800 underline font-medium">
                                        <%= line.product_version_name %>
                                    </a>
                                </td>
                                <td>
                                    <% 
                                        let badgeClass = '';
                                        let trackingText = '';
                                        switch(line.tracking_mode) {
                                            case 'none': 
                                                badgeClass = 'bg-gray-100 text-gray-700';
                                                trackingText = 'Geen tracking';
                                                break;
                                            case 'imei':
                                                badgeClass = 'bg-blue-100 text-blue-700';
                                                trackingText = 'IMEI';
                                                break;
                                            case 'serial':
                                                badgeClass = 'bg-amber-100 text-amber-700';
                                                trackingText = 'Serienummer';
                                                break;
                                        }
                                    %>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= badgeClass %>">
                                        <%= trackingText %>
                                    </span>
                                </td>
                                <td class="font-medium text-gray-900">
                                    <%= line.quantity %> stuks
                                </td>
                                <td>
                                    <% if (line.purchase_price_per_unit) { %>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                            â‚¬<%= parseFloat(line.purchase_price_per_unit).toFixed(2) %>
                                        </span>
                                    <% } else { %>
                                        <span class="text-gray-400">Geen prijs</span>
                                    <% } %>
                                </td>
                                <td class="font-medium text-gray-900">
                                    <% if (line.purchase_price_per_unit) { %>
                                        â‚¬<%= (parseFloat(line.purchase_price_per_unit) * line.quantity).toFixed(2) %>
                                    <% } else { %>
                                        <span class="text-gray-400">-</span>
                                    <% } %>
                                </td>
                                <td class="text-sm text-gray-500"><%= new Date(line.created_at).toLocaleDateString('nl-NL') %></td>
                                <% if (delivery.status === 'concept') { %>
                                    <td>
                                        <button class="text-red-600 hover:text-red-800 text-sm font-medium">
                                            Verwijderen
                                        </button>
                                    </td>
                                <% } %>
                            </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } %>
    </div>
</div>

<!-- Identifiers by Product Version -->
<% 
let hasIdentifiers = lines.some(line => line.identifiers && line.identifiers.length > 0);
%>

<% if (hasIdentifiers) { %>
<div class="space-y-6">
    <% lines.forEach(line => { %>
        <% if (line.identifiers && line.identifiers.length > 0) { %>
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-barcode mr-2 text-purple-600"></i>
                        <%= line.product_version_name %>
                        <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                            <%= line.identifiers.length %> identifiers
                        </span>
                    </h3>
                    <div class="text-sm text-gray-500">
                        <% 
                            let trackingBadgeClass = '';
                            let trackingText = '';
                            switch(line.tracking_mode) {
                                case 'imei':
                                    trackingBadgeClass = 'bg-blue-100 text-blue-700';
                                    trackingText = 'IMEI tracking';
                                    break;
                                case 'serial':
                                    trackingBadgeClass = 'bg-amber-100 text-amber-700';
                                    trackingText = 'Serial tracking';
                                    break;
                            }
                        %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= trackingBadgeClass %>">
                            <%= trackingText %>
                        </span>
                    </div>
                </div>
            </div>
            
            <table class="table-minimal w-full">
                <thead>
                    <tr>
                        <th class="w-8">
                            <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        </th>
                        <th class="text-left">ID</th>
                        <% if (line.tracking_mode === 'imei') { %>
                            <th class="text-left">IMEI</th>
                        <% } %>
                        <% if (line.tracking_mode === 'serial') { %>
                            <th class="text-left">Serienummer</th>
                        <% } %>
                        <th class="text-left">Status</th>
                        <th class="text-left">Inkoopprijs</th>
                        <th class="text-left">Wijzigingen</th>
                        <th class="text-left">Acties</th>
                    </tr>
                </thead>
                <tbody>
                    <% line.identifiers.forEach(identifier => { %>
                        <tr class="group">
                            <td>
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </td>
                            <td class="font-medium text-gray-900"><%= identifier.id %></td>
                            <% if (line.tracking_mode === 'imei') { %>
                                <td>
                                    <% if (identifier.original_imei) { %>
                                        <code class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-800"><%= identifier.original_imei %></code>
                                    <% } else { %>
                                        <span class="text-gray-400">-</span>
                                    <% } %>
                                </td>
                            <% } %>
                            <% if (line.tracking_mode === 'serial') { %>
                                <td>
                                    <% if (identifier.original_serial_number) { %>
                                        <code class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-800"><%= identifier.original_serial_number %></code>
                                    <% } else { %>
                                        <span class="text-gray-400">-</span>
                                    <% } %>
                                </td>
                            <% } %>
                            <td>
                                <% 
                                    let statusBadgeClass = '';
                                    let statusText = '';
                                    switch(identifier.status) {
                                        case 'in_stock':
                                            statusBadgeClass = 'bg-green-100 text-green-700';
                                            statusText = 'Op voorraad';
                                            break;
                                        case 'sold':
                                            statusBadgeClass = 'bg-blue-100 text-blue-700';
                                            statusText = 'Verkocht';
                                            break;
                                        case 'defective':
                                            statusBadgeClass = 'bg-red-100 text-red-700';
                                            statusText = 'Defect';
                                            break;
                                        case 'missing':
                                            statusBadgeClass = 'bg-amber-100 text-amber-700';
                                            statusText = 'Vermist';
                                            break;
                                        case 'reserved':
                                            statusBadgeClass = 'bg-purple-100 text-purple-700';
                                            statusText = 'Gereserveerd';
                                            break;
                                        case 'defective_at_delivery':
                                            statusBadgeClass = 'bg-orange-100 text-orange-700';
                                            statusText = 'Defect bij levering';
                                            break;
                                        case 'returned_to_supplier':
                                            statusBadgeClass = 'bg-gray-100 text-gray-700';
                                            statusText = 'Geretourneerd';
                                            break;
                                        case 'written_off':
                                            statusBadgeClass = 'bg-black text-white';
                                            statusText = 'Afgeboekt';
                                            break;
                                    }
                                %>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= statusBadgeClass %>">
                                    <%= statusText %>
                                </span>
                            </td>
                            <td>
                                <% if (identifier.purchase_price) { %>
                                    <span class="font-medium text-gray-900">â‚¬<%= parseFloat(identifier.purchase_price).toFixed(2) %></span>
                                <% } else { %>
                                    <span class="text-gray-400">-</span>
                                <% } %>
                            </td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <% if (identifier.is_identifier_swapped) { %>
                                        <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700" title="Identifier gewijzigd na levering">
                                            <i class="fas fa-exchange-alt"></i>
                                        </span>
                                    <% } %>
                                    <% if (identifier.is_product_version_swapped) { %>
                                        <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700" title="Productversie gewijzigd na levering">
                                            <i class="fas fa-arrow-right"></i>
                                        </span>
                                    <% } %>
                                    <% if (!identifier.is_identifier_swapped && !identifier.is_product_version_swapped) { %>
                                        <span class="text-gray-400">-</span>
                                    <% } %>
                                </div>
                            </td>
                            <td>
                                <button onclick="window.location.href='/identifiers/<%= identifier.id %>'" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Bekijken
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>
    <% }); %>
</div>
<% } %>

<script>
// Handle product version selection for tracking mode display
document.getElementById('product_version_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const trackingMode = selectedOption.getAttribute('data-tracking');
    const trackingInfo = document.getElementById('trackingInfo');
    const identifierFields = document.getElementById('identifierFields');
    const quantity = document.getElementById('quantity');
    
    if (trackingMode) {
        let trackingText = '';
        let showIdentifiers = false;
        
        switch(trackingMode) {
            case 'none':
                trackingText = 'Geen tracking - identifiers niet vereist';
                break;
            case 'imei':
                trackingText = 'IMEI tracking - IMEI codes vereist';
                showIdentifiers = true;
                break;
            case 'serial':
                trackingText = 'Serienummer tracking - serienummers vereist';
                showIdentifiers = true;
                break;
        }
        
        trackingInfo.innerHTML = '<strong>' + trackingText + '</strong>';
        
        if (showIdentifiers) {
            identifierFields.style.display = 'block';
        } else {
            identifierFields.style.display = 'none';
        }
    } else {
        trackingInfo.innerHTML = 'Selecteer eerst een productversie';
        identifierFields.style.display = 'none';
    }
});

// Generate identifier input fields based on quantity
document.getElementById('quantity').addEventListener('input', function() {
    const quantity = parseInt(this.value) || 0;
    const productVersionSelect = document.getElementById('product_version_id');
    const selectedOption = productVersionSelect.options[productVersionSelect.selectedIndex];
    const trackingMode = selectedOption.getAttribute('data-tracking');
    const identifierInputs = document.getElementById('identifierInputs');
    
    if (quantity > 0 && trackingMode && trackingMode !== 'none') {
        let html = '';
        
        for (let i = 1; i <= quantity; i++) {
            html += '<div class="row mb-2"><div class="col-md-1"><label class="form-label">' + i + '.</label></div>';
            
            if (trackingMode === 'imei') {
                html += '<div class="col-md-5"><input type="text" class="form-control" name="identifiers[' + (i-1) + '][imei]" placeholder="IMEI" required></div>';
            }
            
            if (trackingMode === 'serial') {
                html += '<div class="col-md-5"><input type="text" class="form-control" name="identifiers[' + (i-1) + '][serial_number]" placeholder="Serienummer" required></div>';
            }
            
            html += '</div>';
        }
        
        identifierInputs.innerHTML = html;
    } else {
        identifierInputs.innerHTML = '';
    }
});

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<%- include('partials/footer') %>