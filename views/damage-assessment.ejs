<%- include('partials/header', { title: 'Schade beoordeling - Levering ' + delivery.delivery_number }) %>

<!-- Page Header -->
<div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold text-gray-900 tracking-tight uppercase">
        SCHADE BEOORDELING - LEVERING <%= delivery.delivery_number %>
    </h1>
    <div class="flex items-center gap-3">
        <button onclick="window.location.href='/deliveries'" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Terug naar overzicht
        </button>
    </div>
</div>

<!-- Instructions -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
    <div class="flex items-start">
        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
        <div>
            <h3 class="text-sm font-medium text-blue-800 mb-2">Instructies voor schade beoordeling</h3>
            <p class="text-sm text-blue-700">
                Controleer elk ontvangen artikel op schade. Vink de checkbox aan als er schade is geconstateerd en beschrijf kort de schade. 
                Items zonder schade worden automatisch op voorraad gezet. Beschadigde items gaan naar de schade review voor verdere afhandeling.
            </p>
        </div>
    </div>
</div>

<!-- Delivery Info -->
<div class="bg-white rounded-lg border border-gray-200 p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <span class="text-sm font-medium text-gray-500">Leveringsnummer:</span>
            <span class="block text-lg font-semibold text-gray-900"><%= delivery.delivery_number %></span>
        </div>
        <div>
            <span class="text-sm font-medium text-gray-500">Leverancier:</span>
            <span class="block text-lg text-gray-900"><%= delivery.supplier || 'Niet opgegeven' %></span>
        </div>
        <div>
            <span class="text-sm font-medium text-gray-500">Totaal aantal artikelen:</span>
            <span class="block text-lg font-semibold text-gray-900"><%= identifiers.length %></span>
        </div>
    </div>
</div>

<!-- Damage Assessment Form -->
<form method="POST" action="/deliveries/<%= delivery.id %>/assess-damage" id="damageAssessmentForm">
    <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-search mr-2 text-blue-600"></i>
                Schade beoordeling per artikel
            </h2>
        </div>
        
        <div class="divide-y divide-gray-200">
            <% identifiers.forEach((identifier, index) => { %>
                <div class="p-6 <%= index % 2 === 0 ? 'bg-gray-50' : '' %>">
                    <div class="flex items-start justify-between">
                        <!-- Product Info -->
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-900 mb-2"><%= identifier.product_name %></h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                <div>
                                    <span class="font-medium">ID:</span> #<%= identifier.id %>
                                </div>
                                <% if (identifier.imei) { %>
                                    <div>
                                        <span class="font-medium">IMEI:</span> 
                                        <code class="bg-gray-100 px-2 py-1 rounded text-gray-800"><%= identifier.imei %></code>
                                    </div>
                                <% } %>
                                <% if (identifier.serial_number) { %>
                                    <div>
                                        <span class="font-medium">Serienummer:</span>
                                        <code class="bg-gray-100 px-2 py-1 rounded text-gray-800"><%= identifier.serial_number %></code>
                                    </div>
                                <% } %>
                                <div>
                                    <span class="font-medium">Inkoopprijs:</span> €<%= parseFloat(identifier.purchase_price || 0).toFixed(2) %>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Damage Assessment -->
                        <div class="ml-6 flex-shrink-0">
                            <div class="bg-white border border-gray-300 rounded-lg p-4" style="min-width: 300px;">
                                <div class="flex items-center mb-3">
                                    <input 
                                        type="checkbox" 
                                        id="damage_<%= identifier.id %>" 
                                        name="damage_assessment[<%= identifier.id %>][is_damaged]" 
                                        value="true"
                                        onchange="toggleDamageDescription(<%= identifier.id %>)"
                                        class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                                    >
                                    <label for="damage_<%= identifier.id %>" class="ml-2 text-sm font-medium text-gray-900">
                                        Schade geconstateerd
                                    </label>
                                </div>
                                
                                <div id="damage_description_<%= identifier.id %>" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Beschrijving van schade *
                                    </label>
                                    <textarea 
                                        name="damage_assessment[<%= identifier.id %>][damage_description]"
                                        rows="3"
                                        placeholder="Beschrijf kort de geconstateerde schade..."
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="mt-8 flex justify-center">
        <button 
            type="submit" 
            class="inline-flex items-center px-8 py-3 bg-green-600 hover:bg-green-700 text-white text-lg font-medium rounded-lg transition-colors"
            onclick="return validateForm()"
        >
            <i class="fas fa-check mr-2"></i>
            Voltooien en levering boeken
        </button>
    </div>
</form>

<script>
function toggleDamageDescription(identifierId) {
    const checkbox = document.getElementById(`damage_${identifierId}`);
    const descriptionDiv = document.getElementById(`damage_description_${identifierId}`);
    const textarea = descriptionDiv.querySelector('textarea');
    
    if (checkbox.checked) {
        descriptionDiv.style.display = 'block';
        textarea.required = true;
    } else {
        descriptionDiv.style.display = 'none';
        textarea.required = false;
        textarea.value = '';
    }
}

function validateForm() {
    let isValid = true;
    let errorMessages = [];
    
    // Check if any damage descriptions are required but empty
    const damageCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="damage_"]');
    
    damageCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const identifierId = checkbox.id.replace('damage_', '');
            const textarea = document.querySelector(`textarea[name="damage_assessment[${identifierId}][damage_description]"]`);
            
            if (!textarea.value.trim()) {
                isValid = false;
                errorMessages.push(`Beschrijving van schade is verplicht voor artikel ID #${identifierId}`);
                textarea.classList.add('border-red-500');
            } else {
                textarea.classList.remove('border-red-500');
            }
        }
    });
    
    if (!isValid) {
        alert('Let op:\\n\\n' + errorMessages.join('\\n'));
        return false;
    }
    
    // Confirm submission
    const damagedCount = document.querySelectorAll('input[type="checkbox"][id^="damage_"]:checked').length;
    const totalCount = <%= identifiers.length %>;
    const goodCount = totalCount - damagedCount;
    
    const message = `Bevestig schade beoordeling:\\n\\n` +
                   `• ${goodCount} artikelen in goede staat (op voorraad)\\n` +
                   `• ${damagedCount} artikelen met schade (naar review)\\n\\n` +
                   `Na bevestiging wordt de levering definitief geboekt.`;
    
    return confirm(message);
}
</script>

<%- include('partials/footer') %>